"use strict";(self.webpackChunk_hdsp_agent_extension=self.webpackChunk_hdsp_agent_extension||[]).push([[966],{2966:(e,t,n)=>{n.r(t),n.d(t,{default:()=>de});var o=n(7495),a=n(7324),r=n(3345),s=n.n(r),l=n(5882);const i=({onClose:e,onSave:t,currentConfig:n})=>{const[o,a]=(0,r.useState)(n?.provider||"gemini"),[l,i]=(0,r.useState)(!1),[c,d]=(0,r.useState)(null),[p,u]=(0,r.useState)(n?.gemini?.apiKey||""),m=e=>e&&["gemini-2.5-pro","gemini-2.5-flash"].includes(e)?e:(console.warn(`[SettingsPanel] Invalid Gemini model "${e}", defaulting to gemini-2.5-pro`),"gemini-2.5-pro"),[g,h]=(0,r.useState)(m(n?.gemini?.model)),[f,y]=(0,r.useState)(n?.vllm?.endpoint||"http://localhost:8000"),[b,v]=(0,r.useState)(n?.vllm?.apiKey||""),[x,E]=(0,r.useState)(n?.vllm?.model||"meta-llama/Llama-2-7b-chat-hf"),[w,k]=(0,r.useState)(n?.openai?.apiKey||""),[C,S]=(0,r.useState)(n?.openai?.model||"gpt-4");(0,r.useEffect)(()=>{n&&(a(n.provider||"gemini"),u(n.gemini?.apiKey||""),h(m(n.gemini?.model)),y(n.vllm?.endpoint||"http://localhost:8000"),v(n.vllm?.apiKey||""),E(n.vllm?.model||"meta-llama/Llama-2-7b-chat-hf"),k(n.openai?.apiKey||""),S(n.openai?.model||"gpt-4"))},[n]);const j=e=>{const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length&&t.pop()?.split(";").shift()||""},P=()=>({provider:o,gemini:{apiKey:p,model:g},vllm:{endpoint:f,apiKey:b,model:x},openai:{apiKey:w,model:C}});return s().createElement("div",{className:"jp-agent-settings-overlay"},s().createElement("div",{className:"jp-agent-settings-dialog"},s().createElement("div",{className:"jp-agent-settings-header"},s().createElement("h2",null,"LLM 설정"),s().createElement("button",{className:"jp-agent-settings-close",onClick:e,title:"닫기"},"×")),s().createElement("div",{className:"jp-agent-settings-content"},s().createElement("div",{className:"jp-agent-settings-group"},s().createElement("label",{className:"jp-agent-settings-label"},"프로바이더"),s().createElement("select",{className:"jp-agent-settings-select",value:o,onChange:e=>a(e.target.value)},s().createElement("option",{value:"gemini"},"Google Gemini"),s().createElement("option",{value:"vllm"},"vLLM"),s().createElement("option",{value:"openai"},"OpenAI"))),"gemini"===o&&s().createElement("div",{className:"jp-agent-settings-provider"},s().createElement("h3",null,"Gemini 설정"),s().createElement("div",{className:"jp-agent-settings-group"},s().createElement("label",{className:"jp-agent-settings-label"},"API 키"),s().createElement("input",{type:"password",className:"jp-agent-settings-input",value:p,onChange:e=>u(e.target.value),placeholder:"Gemini API 키를 입력하세요"})),s().createElement("div",{className:"jp-agent-settings-group"},s().createElement("label",{className:"jp-agent-settings-label"},"모델"),s().createElement("select",{className:"jp-agent-settings-select",value:g,onChange:e=>h(e.target.value)},s().createElement("option",{value:"gemini-2.5-pro"},"Gemini 2.5 Pro"),s().createElement("option",{value:"gemini-2.5-flash"},"Gemini 2.5 Flash")))),"vllm"===o&&s().createElement("div",{className:"jp-agent-settings-provider"},s().createElement("h3",null,"vLLM 설정"),s().createElement("div",{className:"jp-agent-settings-group"},s().createElement("label",{className:"jp-agent-settings-label"},"서버 주소"),s().createElement("input",{type:"text",className:"jp-agent-settings-input",value:f,onChange:e=>y(e.target.value),placeholder:"http://localhost:8000"})),s().createElement("div",{className:"jp-agent-settings-group"},s().createElement("label",{className:"jp-agent-settings-label"},"API 키 (선택사항)"),s().createElement("input",{type:"password",className:"jp-agent-settings-input",value:b,onChange:e=>v(e.target.value),placeholder:"API 키가 필요한 경우 입력"})),s().createElement("div",{className:"jp-agent-settings-group"},s().createElement("label",{className:"jp-agent-settings-label"},"모델 이름"),s().createElement("input",{type:"text",className:"jp-agent-settings-input",value:x,onChange:e=>E(e.target.value),placeholder:"meta-llama/Llama-2-7b-chat-hf"}))),"openai"===o&&s().createElement("div",{className:"jp-agent-settings-provider"},s().createElement("h3",null,"OpenAI 설정"),s().createElement("div",{className:"jp-agent-settings-group"},s().createElement("label",{className:"jp-agent-settings-label"},"API 키"),s().createElement("input",{type:"password",className:"jp-agent-settings-input",value:w,onChange:e=>k(e.target.value),placeholder:"sk-..."})),s().createElement("div",{className:"jp-agent-settings-group"},s().createElement("label",{className:"jp-agent-settings-label"},"모델"),s().createElement("select",{className:"jp-agent-settings-select",value:C,onChange:e=>S(e.target.value)},s().createElement("option",{value:"gpt-4"},"GPT-4"),s().createElement("option",{value:"gpt-4-turbo"},"GPT-4 Turbo"),s().createElement("option",{value:"gpt-3.5-turbo"},"GPT-3.5 Turbo"))))),c&&s().createElement("div",{className:"jp-agent-settings-test-result"},c),s().createElement("div",{className:"jp-agent-settings-footer"},s().createElement("button",{className:"jp-agent-settings-button jp-agent-settings-button-secondary",onClick:e},"취소"),s().createElement("button",{className:"jp-agent-settings-button jp-agent-settings-button-test",onClick:async()=>{i(!0),d(null);try{const e=P(),t=await fetch("/hdsp-agent/test-llm",{method:"POST",headers:{"Content-Type":"application/json","X-XSRFToken":j("_xsrf")},body:JSON.stringify(e)});if(t.ok){const e=await t.json();d(`✅ 성공: ${e.message}`)}else{const e=await t.json();d(`❌ 실패: ${e.error}`)}}catch(e){d(`❌ 오류: ${e instanceof Error?e.message:"알 수 없는 오류"}`)}finally{i(!1)}},disabled:l},l?"테스트 중...":"API 테스트"),s().createElement("button",{className:"jp-agent-settings-button jp-agent-settings-button-primary",onClick:()=>{const n=P();t(n),e()}},"저장"))))};function c(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function d(e,t){const n=document.createElement("span");let o=0;for(;o<e.length;){if("`"===e[o]){let t=o+1,a=!1;for(;t<e.length;)if("\\"!==e[t]||a){if("`"===e[t]&&!a)break;a=!1,t++}else a=!0,t++;if(t<e.length&&"`"===e[t]){const a=document.createElement("span");a.style.color="#ce9178",a.textContent=e.substring(o,t+1),n.appendChild(a),o=t+1;continue}}if('"'===e[o]){let t=o+1,a=!1;for(;t<e.length;)if("\\"!==e[t]||a){if('"'===e[t]&&!a)break;a=!1,t++}else a=!0,t++;if(t<e.length&&'"'===e[t]){const a=document.createElement("span");a.style.color="#ce9178",a.textContent=e.substring(o,t+1),n.appendChild(a),o=t+1;continue}const r=document.createElement("span");r.style.color="#ce9178",r.textContent=e.substring(o),n.appendChild(r);break}if("'"===e[o]){let t=o+1,a=!1;for(;t<e.length;)if("\\"!==e[t]||a){if("'"===e[t]&&!a)break;a=!1,t++}else a=!0,t++;if(t<e.length&&"'"===e[t]){const a=document.createElement("span");a.style.color="#ce9178",a.textContent=e.substring(o,t+1),n.appendChild(a),o=t+1;continue}const r=document.createElement("span");r.style.color="#ce9178",r.textContent=e.substring(o),n.appendChild(r);break}if(/\d/.test(e[o])){let t=o;for(;t<e.length&&/[\d.]/.test(e[t]);)t++;const a=document.createElement("span");a.style.color="#b5cea8",a.textContent=e.substring(o,t),n.appendChild(a),o=t;continue}if(/[a-zA-Z_$]/.test(e[o])){let a=o;for(;a<e.length&&/[a-zA-Z0-9_$]/.test(e[a]);)a++;const r=e.substring(o,a);if(t.includes(r)){const e=document.createElement("span");e.style.color="#569cd6",e.style.fontWeight="500",e.textContent=r,n.appendChild(e)}else{const e=document.createTextNode(r);n.appendChild(e)}o=a;continue}const a=document.createTextNode(e[o]);n.appendChild(a),o++}return n.innerHTML}function p(e){let t=c(e);return t=t.replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>'),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t}function u(e){const t=e.trim().split("\n");if(t.length<2)return c(e);const n=t.findIndex(e=>/^\|?\s*[-:]+[-|\s:]+\s*\|?$/.test(e));if(-1===n||0===n)return c(e);const o=t.slice(0,n),a=t[n],r=t.slice(n+1),s=[];a.split("|").filter(e=>e.trim()).forEach(e=>{const t=e.trim();t.startsWith(":")&&t.endsWith(":")?s.push("center"):t.endsWith(":")?s.push("right"):s.push("left")});let l='<table class="markdown-table">';return l+="<thead>",o.forEach(e=>{l+="<tr>",e.split("|").filter((e,t,n)=>!(0===t&&""===e.trim()||t===n.length-1&&""===e.trim())).forEach((e,t)=>{const n=s[t]||"left";l+=`<th style="text-align: ${n};">${p(e.trim())}</th>`}),l+="</tr>"}),l+="</thead>",r.length>0&&(l+="<tbody>",r.forEach(e=>{e.trim()&&(l+="<tr>",e.split("|").filter((e,t,n)=>!(0===t&&""===e.trim()||t===n.length-1&&""===e.trim())).forEach((e,t)=>{const n=s[t]||"left";l+=`<td style="text-align: ${n};">${p(e.trim())}</td>`}),l+="</tr>")}),l+="</tbody>"),l+="</table>",l}function m(e){const t=document.createElement("textarea");t.innerHTML=e;let n=t.value;const o=[],a=[];n=n.replace(/```(\w+)?\n([\s\S]*?)```/g,(e,t,n)=>{const r=(t||"python").toLowerCase(),s=function(e){const t=e.split("\n");let n=1/0;const o=[];for(let e=0;e<t.length;e++){const a=t[e];if(a.trim().length>0){const t=a.match(/^(\s*)/),r=t?t[1].length:0;n=Math.min(n,r),o.push(e)}}return n===1/0||0===n?e:t.map(e=>0===e.trim().length?"":e.substring(n)).join("\n")}(n.trim()),l="code-block-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),i="__CODE_BLOCK_"+l+"__";o.push({id:l,code:s,language:r});const p="python"===r||"py"===r?function(e){let t=e;const n="color: #ce9178;",o=[];let a=0;return t=t.replace(/(#.*$)/gm,e=>{const t=`__PH${a++}__`;return o.push({id:t,html:`<span style="color: #6a9955; font-style: italic;">${c(e)}</span>`}),t}),t=t.replace(/(['"]{3})([\s\S]*?)(\1)/g,e=>{const t=`__PH${a++}__`;return o.push({id:t,html:`<span style="${n}">${c(e)}</span>`}),t}),t=t.replace(/(['"])([^'"]*?)(\1)/g,e=>{const t=`__PH${a++}__`;return o.push({id:t,html:`<span style="${n}">${c(e)}</span>`}),t}),t=t.replace(/\b(\d+\.?\d*)\b/g,e=>{const t=`__PH${a++}__`;return o.push({id:t,html:`<span style="color: #b5cea8;">${e}</span>`}),t}),["def","class","if","elif","else","for","while","return","import","from","as","try","except","finally","with","lambda","yield","async","await","pass","break","continue","raise","assert","del","global","nonlocal","True","False","None","and","or","not","in","is"].forEach(e=>{const n=new RegExp(`\\b${e}\\b`,"g");t=t.replace(n,e=>{const t=`__PH${a++}__`;return o.push({id:t,html:`<span style="color: #c586c0; font-weight: bold;">${e}</span>`}),t})}),["print","len","range","str","int","float","list","dict","tuple","set","bool","type","isinstance","issubclass","hasattr","getattr","setattr","delattr","dir","vars","locals","globals","input","open","file","abs","all","any","bin","chr","ord","hex","oct","pow","round","sum","min","max","sorted","reversed","enumerate","zip","map","filter","reduce"].forEach(e=>{const n=new RegExp(`\\b${e}\\b`,"g");t=t.replace(n,e=>{const t=`__PH${a++}__`;return o.push({id:t,html:`<span style="color: #dcdcaa;">${e}</span>`}),t})}),t=t.replace(/(__PH\d+__\s+)([a-zA-Z_][a-zA-Z0-9_]*)/g,(e,t,n)=>{const r=o.find(e=>e.id===t.trim());if(r&&r.html.includes("def")){const e=`__PH${a++}__`;return o.push({id:e,html:`<span style="color: #4fc1ff; font-weight: bold;">${n}</span>`}),t+e}return e}),t=t.split(/(__PH\d+__)/g).map(e=>e.match(/^__PH\d+__$/)?e:e=(e=(e=c(e)).replace(/([+\-*/%=<>!&|^~]+)/g,'<span style="color: #d4d4d4;">$1</span>')).replace(/([()[\]{}])/g,'<span style="color: #d4d4d4;">$1</span>')).join(""),o.forEach(e=>{t=t.replace(e.id,e.html)}),t}(s):"javascript"===r||"js"===r?function(e){const t=c(e).split("\n"),n=["function","const","let","var","if","else","for","while","return","class","import","export","from","async","await","new","this","null","undefined","true","false","typeof"];let o=!1;return t.map(e=>{if(o){const t=e.indexOf("*/");return-1!==t?(o=!1,`<span style="color: #6a9955; font-style: italic;">${e.substring(0,t+2)}</span>`+d(e.substring(t+2),n)):`<span style="color: #6a9955; font-style: italic;">${e}</span>`}const t=e.match(/^(\s*)(\/\/.*)$/);if(t)return t[1]+`<span style="color: #6a9955; font-style: italic;">${t[2]}</span>`;const a=e.indexOf("/*");if(-1!==a){const t=e.indexOf("*/",a);return-1!==t?d(e.substring(0,a),n)+`<span style="color: #6a9955; font-style: italic;">${e.substring(a,t+2)}</span>`+d(e.substring(t+2),n):(o=!0,d(e.substring(0,a),n)+`<span style="color: #6a9955; font-style: italic;">${e.substring(a)}</span>`)}const r=e.indexOf("//");return-1!==r?d(e.substring(0,r),n)+`<span style="color: #6a9955; font-style: italic;">${e.substring(r)}</span>`:d(e,n)}).join("\n")}(s):c(s),u='<div class="code-block-container" data-block-id="'+l+'"><div class="code-block-header"><span class="code-block-language">'+c(r)+'</span><div class="code-block-actions"><button class="code-block-apply" data-block-id="'+l+'" title="셀에 적용">셀에 적용</button><button class="code-block-copy" data-block-id="'+l+'" title="복사">복사</button></div></div><pre class="code-block language-'+c(r)+'"><code id="'+l+'">'+p+"</code></pre></div>";return a.push({placeholder:i,html:u}),i});const r=[];n=n.replace(/`([^`]+)`/g,(e,t)=>{const n="__INLINE_CODE_"+Math.random().toString(36).substr(2,9)+"__";return r.push({placeholder:n,html:'<code class="inline-code">'+c(t)+"</code>"}),n});const s=[];return n=n.replace(/(?:^|\n)((?:\|[^\n]+\|?\n)+\|?\s*[-:|\s]+\s*\|?\n(?:\|[^\n]+\|?\n?)*)/gm,(e,t)=>{const n="__TABLE_"+Math.random().toString(36).substr(2,9)+"__",o=u(t.trim());return s.push({placeholder:n,html:o}),"\n"+n+"\n"}),n=n.replace(/(?:^|\n)((?:[^\n|]+\|[^\n]+\n)+[-:|\s]+\n(?:[^\n|]+\|[^\n]+\n?)*)/gm,(e,t)=>{if(t.includes("__TABLE_"))return e;const n="__TABLE_"+Math.random().toString(36).substr(2,9)+"__",o=u(t.trim());return s.push({placeholder:n,html:o}),"\n"+n+"\n"}),n=n.split(/(__(?:CODE_BLOCK|INLINE_CODE|TABLE)_[a-z0-9-]+__)/gi).map((e,t)=>t%2==1?e:c(e)).join(""),n=n.replace(/^###### (.*$)/gim,"<h6>$1</h6>"),n=n.replace(/^##### (.*$)/gim,"<h5>$1</h5>"),n=n.replace(/^#### (.*$)/gim,"<h4>$1</h4>"),n=n.replace(/^### (.*$)/gim,"<h3>$1</h3>"),n=n.replace(/^## (.*$)/gim,"<h2>$1</h2>"),n=n.replace(/^# (.*$)/gim,"<h1>$1</h1>"),n=n.replace(/^---+$/gim,"<hr>"),n=n.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),n=n.replace(/^[\-\*]\s+(.*$)/gim,"<li>$1</li>"),n=n.replace(/^\d+\.\s+(.*$)/gim,"<li>$1</li>"),n=n.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),n=n.replace(/(?<!\*)\*([^*\n]+)\*(?!\*)/g,"<em>$1</em>"),n=n.replace(/\n/g,"<br>"),s.forEach(e=>{n=n.replace(e.placeholder,e.html)}),r.forEach(e=>{n=n.replace(e.placeholder,e.html)}),a.forEach(e=>{n=n.replace(e.placeholder,e.html)}),n}const g=(0,r.forwardRef)(({apiService:e},t)=>{const[n,o]=(0,r.useState)([]),[a,l]=(0,r.useState)(""),[c,d]=(0,r.useState)(!1),[p,u]=(0,r.useState)(!1),[g,h]=(0,r.useState)(null),[f,y]=(0,r.useState)(""),[b,v]=(0,r.useState)(!1),[x,E]=(0,r.useState)(null),w=(0,r.useRef)(null),k=(0,r.useRef)(null),C=(0,r.useRef)([]),S=(0,r.useRef)(null),j=(0,r.useRef)(null);(0,r.useImperativeHandle)(t,()=>({handleSendMessage:async()=>{await M()},setInput:e=>{l(e)},setLlmPrompt:e=>{k.current=e;const t=w.current?.parentElement?.querySelector(".jp-agent-input");t&&t.setAttribute("data-llm-prompt",e)},setCurrentCellId:e=>{console.log("[AgentPanel] setCurrentCellId called with:",e),S.current=e},setCurrentCellIndex:e=>{console.log("[AgentPanel] setCurrentCellIndex called with:",e),j.current=e}})),(0,r.useEffect)(()=>{P()},[]);const P=async()=>{try{const t=await e.getConfig();if(!t||!t.provider)return console.warn("Config missing provider, using default"),void E({provider:"gemini",gemini:{apiKey:"",model:"gemini-2.5-pro"},vllm:{endpoint:"http://localhost:8000",apiKey:"test",model:"gpt-oss-120b"},openai:{apiKey:"",model:"gpt-4"}});E(t);const n=t;console.log("=== HDSP Agent Model Configuration ==="),console.log("Provider:",n.provider),"gemini"===n.provider?(console.log("Gemini Model:",n.gemini?.model||"gemini-pro (default)"),console.log("Gemini API Key:",n.gemini?.apiKey?"✓ Configured":"✗ Not configured")):"vllm"===n.provider?(console.log("vLLM Model:",n.vllm?.model||"default"),console.log("vLLM Endpoint:",n.vllm?.endpoint||"http://localhost:8000"),console.log("vLLM API Key:",n.vllm?.apiKey?"✓ Configured":"✗ Not configured")):"openai"===n.provider&&(console.log("OpenAI Model:",n.openai?.model||"gpt-4"),console.log("OpenAI API Key:",n.openai?.apiKey?"✓ Configured":"✗ Not configured")),console.log("=====================================")}catch(e){console.error("Failed to load config:",e)}};(0,r.useEffect)(()=>{w.current?.scrollIntoView({behavior:"smooth"})},[n]),(0,r.useEffect)(()=>{const e=setTimeout(()=>{const e=document.querySelector(".jp-agent-messages")||w.current?.parentElement||document.querySelector('[class*="jp-agent-messages"]');if(!e)return void console.log("[AgentPanel] Messages container not found");const t=[],n=e.querySelectorAll(".code-block-container");console.log(`[AgentPanel] Found ${n.length} code block containers`),n.forEach(e=>{const n=e.getAttribute("data-block-id");if(!n)return void console.warn("[AgentPanel] Code block container missing data-block-id");const o=e.querySelector(`#${n}`);if(!o)return void console.warn(`[AgentPanel] Code element #${n} not found`);const a=o.textContent||"",r=e.querySelector(".code-block-language"),s=r?.textContent?.toLowerCase()||"python";t.push({id:n,code:a,language:s})}),C.current=t,console.log(`[AgentPanel] Stored ${t.length} code blocks`);const o=async e=>{const t=e.target;if(t.classList.contains("code-block-copy")||t.closest(".code-block-copy")){const n=t.classList.contains("code-block-copy")?t:t.closest(".code-block-copy");e.stopPropagation(),e.preventDefault();const o=n.getAttribute("data-block-id");if(!o)return;const a=C.current.find(e=>e.id===o);if(!a)return;try{await navigator.clipboard.writeText(a.code);const e=n.textContent;n.textContent="복사됨!",setTimeout(()=>{n.textContent=e||"복사"},2e3)}catch(e){console.error("Failed to copy code:",e),A("복사에 실패했습니다.","error")}return}if(t.classList.contains("code-block-apply")||t.closest(".code-block-apply")){const n=t.classList.contains("code-block-apply")?t:t.closest(".code-block-apply");e.stopPropagation(),e.preventDefault();const o=n.getAttribute("data-block-id");if(console.log(`[AgentPanel] Apply button clicked via delegation, blockId: ${o}`),!o)return void A("코드 블록 ID를 찾을 수 없습니다.","error");const a=C.current.find(e=>e.id===o);return a?(console.log(`[AgentPanel] Applying code to cell via delegation, code length: ${a.code.length}`),void await $(a.code,o,n)):void A("코드를 찾을 수 없습니다.","error")}};e.addEventListener("click",o),e._agentPanelClickHandler=o},100);return()=>{clearTimeout(e);const t=document.querySelector(".jp-agent-messages")||w.current?.parentElement||document.querySelector('[class*="jp-agent-messages"]');t&&t._agentPanelClickHandler&&(t.removeEventListener("click",t._agentPanelClickHandler),delete t._agentPanelClickHandler)}},[n]);const A=(e,t="info")=>{const n=((e,t)=>{const n=document.createElement("div");return n.style.cssText=`\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      padding: 12px 16px;\n      border-radius: 6px;\n      color: white;\n      font-size: 14px;\n      font-weight: 500;\n      z-index: 10001;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n      max-width: 300px;\n      word-wrap: break-word;\n      background: ${t};\n    `,n.textContent=e,n})(e,(e=>{switch(e){case"error":return"#f56565";case"warning":return"#ed8936";default:return"#4299e1"}})(t));document.body.appendChild(n),(e=>{setTimeout(()=>e.style.opacity="1",10),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},3e3)})(n)},$=async(e,t,n)=>{console.log("[AgentPanel] applyCodeToCell called",{codeLength:e.length,blockId:t});const o=n.textContent;try{n.disabled=!0,n.textContent="적용 중...";const a=window.jupyterapp;if(!a)return console.error("[AgentPanel] jupyterapp not found in window"),A("JupyterLab을 찾을 수 없습니다.","error"),n.disabled=!1,void(n.textContent=o||"셀에 적용");console.log("[AgentPanel] Found jupyterapp");const r=a.shell.currentWidget;if(r&&"content"in r){const a=r.content;if(a&&"model"in a&&a.model&&"cells"in a.model)return void await L(e,a,t,n,o)}N(e,n,o)}catch(e){console.error("Failed to apply code to cell:",e),A("코드 적용에 실패했습니다.","error"),n.disabled=!1,n.textContent=o||"셀에 적용"}},T=(e,t)=>{if(e.sharedModel&&"function"==typeof e.sharedModel.setSource)e.sharedModel.setSource(t);else if(e.setSource&&"function"==typeof e.setSource)e.setSource(t);else if(e.value&&"function"==typeof e.value.setText)e.value.setText(t);else{if(!e.value||void 0===e.value.text)throw new Error("Unable to set cell source - no compatible method found");e.value.text=t}},I=(e,t)=>{e.disabled=!1,e.textContent=t||"셀에 적용"},L=async(e,t,n,o,a)=>{try{if(console.log("[AgentPanel] applyCodeToNotebookCell called",{currentCellIndex:j.current,currentCellId:S.current,blockId:n}),null!==j.current&&void 0!==j.current){console.log("[AgentPanel] Using cell index:",j.current);const n=t.widgets||[];if(!(j.current>=0&&j.current<n.length))return console.error("[AgentPanel] Cell index out of bounds:",j.current,"cells.length:",n.length),A("대상 셀을 찾을 수 없습니다. 셀이 삭제되었거나 이동했을 수 있습니다.","error"),I(o,a),j.current=null,void(S.current=null);{const t=n[j.current],r=t.model||t;console.log("[AgentPanel] Found cell at index, applying code...");try{return T(r,e),console.log("[AgentPanel] Code applied successfully!"),A("코드가 셀에 적용되었습니다!","info"),I(o,a),j.current=null,void(S.current=null)}catch(e){return console.error("Failed to update cell content:",e),A("셀 내용 업데이트 실패: "+e.message,"error"),void I(o,a)}}}console.log("[AgentPanel] No current cell index set, showing selector dialog"),N(e,o,a)}catch(e){console.error("Failed to apply code:",e),A("코드 적용에 실패했습니다.","error"),I(o,a)}},N=(e,t,n)=>{try{const o=window.jupyterapp;if(!o)return A("JupyterLab을 찾을 수 없습니다.","error"),t.disabled=!1,void(t.textContent=n||"셀에 적용");const a=o.shell.currentWidget;if(!a||!("content"in a))return A("활성 노트북을 찾을 수 없습니다.","warning"),t.disabled=!1,void(t.textContent=n||"셀에 적용");const r=a.content;if(!(r&&"model"in r&&r.model&&"cells"in r.model))return A("활성 노트북을 찾을 수 없습니다.","warning"),t.disabled=!1,void(t.textContent=n||"셀에 적용");const s=r.widgets||[],l=[];if(s.forEach((e,t)=>{const n=e.model||e;if("code"===n.type){const o=n.metadata?.get?.("jupyterAgentCellId")||n.id||`cell-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;try{n.metadata?.get?.("jupyterAgentCellId")||n.metadata?.set&&n.metadata.set("jupyterAgentCellId",o)}catch(e){}const a=(n.sharedModel?.getSource?.()||n.value?.text||"").toString().substring(0,100).replace(/\n/g," ");l.push({cell:e,index:t,id:o,preview:a})}}),0===l.length)return A("코드 셀을 찾을 수 없습니다.","warning"),t.disabled=!1,void(t.textContent=n||"셀에 적용");const i=document.querySelector(".jp-agent-cell-selector-dialog");i&&i.remove();const c=document.createElement("div");c.className="jp-agent-cell-selector-dialog",c.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.3);\n        z-index: 10000;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      ";const d=document.createElement("div");d.style.cssText="\n        background: #fafafa;\n        border: 1px solid #e0e0e0;\n        border-radius: 4px;\n        padding: 24px;\n        max-width: 500px;\n        width: 90%;\n        max-height: 80vh;\n        overflow-y: auto;\n        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      ";const p=l.map(({index:e,id:t,preview:n})=>`\n          <div class="jp-agent-cell-selector-item" data-cell-id="${t}" style="\n            padding: 12px;\n            margin-bottom: 8px;\n            background: white;\n            border: 2px solid #e0e0e0;\n            border-radius: 4px;\n            cursor: pointer;\n            transition: all 0.2s ease;\n          ">\n            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">\n              <span style="\n                background: #667eea;\n                color: white;\n                padding: 2px 8px;\n                border-radius: 12px;\n                font-size: 11px;\n                font-weight: 600;\n              ">셀 ${e+1}</span>\n            </div>\n            <div style="font-size: 12px; color: #757575; font-family: 'Menlo', monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">\n              ${_(n)}${n.length>=100?"...":""}\n            </div>\n          </div>\n        `).join("");d.innerHTML=`\n        <div style="margin-bottom: 20px;">\n          <h3 style="margin: 0 0 8px 0; color: #424242; font-size: 16px; font-weight: 500;">\n            코드를 적용할 셀 선택\n          </h3>\n          <p style="margin: 0; color: #757575; font-size: 13px;">\n            AI가 생성한 코드를 적용할 셀을 선택하세요\n          </p>\n        </div>\n        <div class="jp-agent-cell-list" style="margin-bottom: 20px;">\n          ${p}\n        </div>\n        <div style="display: flex; gap: 12px; justify-content: flex-end;">\n          <button class="jp-agent-cell-selector-cancel-btn" style="\n            background: transparent;\n            color: #616161;\n            border: 1px solid #d1d5db;\n            border-radius: 3px;\n            padding: 8px 16px;\n            font-size: 13px;\n            font-weight: 500;\n            cursor: pointer;\n            transition: all 0.15s ease;\n          ">취소</button>\n        </div>\n      `,c.appendChild(d),document.body.appendChild(c),d.querySelectorAll(".jp-agent-cell-selector-item").forEach(o=>{o.addEventListener("click",()=>{const a=o.getAttribute("data-cell-id");if(!a)return;const r=l.find(e=>e.id===a);if(!r)return;const s=r.cell.model||r.cell;try{T(s,e),A("코드가 셀에 적용되었습니다!","info"),c.remove(),I(t,n)}catch(e){console.error("Failed to apply code to cell:",e),A("코드 적용에 실패했습니다.","error"),I(t,n)}}),o.addEventListener("mouseenter",()=>{o.style.borderColor="#667eea",o.style.background="#f8f9ff"}),o.addEventListener("mouseleave",()=>{o.style.borderColor="#e0e0e0",o.style.background="white"})});const u=d.querySelector(".jp-agent-cell-selector-cancel-btn");u&&(u.addEventListener("click",()=>{c.remove(),t.disabled=!1,t.textContent=n||"셀에 적용"}),u.addEventListener("mouseenter",()=>{u.style.background="#f5f5f5",u.style.borderColor="#9ca3af"}),u.addEventListener("mouseleave",()=>{u.style.background="transparent",u.style.borderColor="#d1d5db"})),c.addEventListener("click",e=>{e.target===c&&(c.remove(),t.disabled=!1,t.textContent=n||"셀에 적용")});const m=e=>{"Escape"===e.key&&(c.remove(),document.removeEventListener("keydown",m),t.disabled=!1,t.textContent=n||"셀에 적용")};document.addEventListener("keydown",m)}catch(e){console.error("Failed to show cell selector:",e),A("셀 선택 다이얼로그 표시에 실패했습니다.","error"),t.disabled=!1,t.textContent=n||"셀에 적용"}},_=e=>{const t=document.createElement("div");return t.textContent=e,t.innerHTML},M=async()=>{const t=w.current?.parentElement?.querySelector(".jp-agent-input"),n=k.current||t?.getAttribute("data-llm-prompt");if(!a.trim()&&!n||c||p)return;if(x||await P(),!(()=>{if(!x||!x.provider)return!1;const e=x.provider;return"gemini"===e?!(!x.gemini?.apiKey||!x.gemini.apiKey.trim()):"vllm"===e?!(!x.vllm?.endpoint||!x.vllm.endpoint.trim()):"openai"===e&&!(!x.openai?.apiKey||!x.openai.apiKey.trim())})()){const e=x?.provider||"LLM",t={id:Date.now().toString(),role:"assistant",content:`⚠️ API Key가 설정되지 않았습니다.\n\n${"gemini"===e?"Gemini":"openai"===e?"OpenAI":"vLLM"} API Key를 먼저 설정해주세요.\n\n설정 버튼을 클릭하여 API Key를 입력하세요.`,timestamp:Date.now()};return o(e=>[...e,t]),void v(!0)}const r=a.trim()||(n?"셀 분석 요청":""),s={id:Date.now().toString(),role:"user",content:r,timestamp:Date.now()};o(e=>[...e,s]),a.trim()&&l(""),d(!0),u(!0),t&&n&&(t.removeAttribute("data-llm-prompt"),k.current=null);const i=Date.now().toString()+"-assistant";let m="";h(i);const g={id:i,role:"assistant",content:"",timestamp:Date.now()};o(e=>[...e,g]);try{const t=n||r;await e.sendMessageStream({message:t,conversationId:f||void 0},e=>{m+=e,o(e=>e.map(e=>e.id===i?{...e,content:m}:e))},e=>{e.conversationId&&!f&&y(e.conversationId),(e.provider||e.model)&&o(t=>t.map(t=>t.id===i?{...t,metadata:{...t.metadata,provider:e.provider,model:e.model}}:t))})}catch(e){o(t=>t.map(t=>t.id===i?{...t,content:m+`\n\nError: ${e instanceof Error?e.message:"Failed to send message"}`}:t))}finally{d(!1),u(!1),h(null)}};return s().createElement("div",{className:"jp-agent-panel"},b&&s().createElement(i,{onClose:()=>v(!1),onSave:async t=>{try{console.log("=== handleSaveConfig 시작 ==="),console.log("전송할 config:",JSON.stringify(t,null,2)),console.log("Provider:",t.provider),console.log("Gemini API Key:",t.gemini?.apiKey?`${t.gemini.apiKey.substring(0,10)}...`:"empty"),await e.saveConfig(t),console.log("서버 저장 완료, state 업데이트 중..."),E(t),await P(),console.log("=== handleSaveConfig 완료 ==="),alert("설정이 성공적으로 저장되었습니다!")}catch(e){console.error("=== handleSaveConfig 실패 ==="),console.error("Error:",e),alert("설정 저장 실패. 다시 시도해주세요.")}},currentConfig:x||void 0}),s().createElement("div",{className:"jp-agent-header"},s().createElement("h2",null,"HDSP Agent"),s().createElement("div",{className:"jp-agent-header-buttons"},s().createElement("button",{className:"jp-agent-clear-button",onClick:()=>{o([]),y("")},title:"대화 초기화"},s().createElement("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("polyline",{points:"3 6 5 6 21 6"}),s().createElement("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}),s().createElement("line",{x1:"10",y1:"11",x2:"10",y2:"17"}),s().createElement("line",{x1:"14",y1:"11",x2:"14",y2:"17"}))),s().createElement("button",{className:"jp-agent-settings-button-icon",onClick:()=>v(!0),title:"설정"},s().createElement("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},s().createElement("line",{x1:"4",y1:"21",x2:"4",y2:"14"}),s().createElement("line",{x1:"4",y1:"10",x2:"4",y2:"3"}),s().createElement("line",{x1:"12",y1:"21",x2:"12",y2:"12"}),s().createElement("line",{x1:"12",y1:"8",x2:"12",y2:"3"}),s().createElement("line",{x1:"20",y1:"21",x2:"20",y2:"16"}),s().createElement("line",{x1:"20",y1:"12",x2:"20",y2:"3"}),s().createElement("line",{x1:"1",y1:"14",x2:"7",y2:"14"}),s().createElement("line",{x1:"9",y1:"8",x2:"15",y2:"8"}),s().createElement("line",{x1:"17",y1:"16",x2:"23",y2:"16"}))))),s().createElement("div",{className:"jp-agent-messages"},0===n.length?s().createElement("div",{className:"jp-agent-empty-state"},s().createElement("p",null,"안녕하세요! HDSP Agent입니다.")):n.map(e=>s().createElement("div",{key:e.id,className:`jp-agent-message jp-agent-message-${e.role}`},s().createElement("div",{className:"jp-agent-message-header"},s().createElement("span",{className:"jp-agent-message-role"},"user"===e.role?"사용자":"Agent"),s().createElement("span",{className:"jp-agent-message-time"},new Date(e.timestamp).toLocaleTimeString())),s().createElement("div",{className:"jp-agent-message-content"+(g===e.id?" streaming":""),dangerouslySetInnerHTML:{__html:"assistant"===e.role?m(e.content):_(e.content).replace(/\n/g,"<br>")}}))),c&&!p&&s().createElement("div",{className:"jp-agent-message jp-agent-message-assistant"},s().createElement("div",{className:"jp-agent-message-header"},s().createElement("span",{className:"jp-agent-message-role"},"Agent")),s().createElement("div",{className:"jp-agent-message-content jp-agent-loading"},s().createElement("span",{className:"jp-agent-loading-dot"},"."),s().createElement("span",{className:"jp-agent-loading-dot"},"."),s().createElement("span",{className:"jp-agent-loading-dot"},"."))),s().createElement("div",{ref:w})),s().createElement("div",{className:"jp-agent-input-container"},s().createElement("div",{className:"jp-agent-input-wrapper"},s().createElement("textarea",{className:"jp-agent-input",value:a,onChange:e=>l(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),M())},placeholder:"코드에 대해 무엇이든 물어보세요...",rows:3,disabled:c}),s().createElement("button",{className:"jp-agent-send-button",onClick:M,disabled:!a.trim()||c||p,title:"메시지 전송 (Enter)"},"전송"))))});g.displayName="ChatPanel";class h extends l.ReactWidget{constructor(e){super(),this.chatPanelRef=s().createRef(),this.apiService=e,this.id="hdsp-agent-panel",this.title.label="HDSP",this.title.caption="HDSP Agent Assistant",this.addClass("jp-agent-widget")}render(){return s().createElement(g,{ref:this.chatPanelRef,apiService:this.apiService})}addCellActionMessage(e,t,n,o,a,r){console.log("[AgentPanel] Cell action:",e),console.log("[AgentPanel] Display prompt:",n),console.log("[AgentPanel] LLM prompt:",o),console.log("[AgentPanel] Cell ID:",a),console.log("[AgentPanel] Cell Index:",r),this.chatPanelRef.current?(void 0!==r&&this.chatPanelRef.current.setCurrentCellIndex&&this.chatPanelRef.current.setCurrentCellIndex(r),a&&this.chatPanelRef.current.setCurrentCellId&&this.chatPanelRef.current.setCurrentCellId(a),this.chatPanelRef.current.setInput(n),this.chatPanelRef.current.setLlmPrompt(o),setTimeout(()=>{this.chatPanelRef.current&&this.chatPanelRef.current.handleSendMessage().catch(e=>{console.error("[AgentPanel] Failed to send message automatically:",e)})},100)):console.error("[AgentPanel] ChatPanel ref not available")}analyzeNotebook(e,t){if(console.log("[AgentPanel] analyzeNotebook called with",e.length,"cells"),!this.chatPanelRef.current)return console.error("[AgentPanel] ChatPanel ref not available"),void t();const n=e.length,o=`전체 노트북 검수 요청 (${n}개 셀)`;let a=`다음은 저장하기 전의 Jupyter 노트북 전체 내용입니다. 모든 셀을 검토하고 개선 사항을 제안해주세요.\n\n## 노트북 요약\n- 전체 셀 수: ${n}개\n- 에러가 있는 셀: ${e.filter(e=>e.output&&(e.output.includes("Error")||e.output.includes("Traceback")||e.output.includes("Exception"))).length}개\n- Import가 있는 셀: ${e.filter(e=>e.imports&&e.imports.length>0).length}개\n- 로컬 모듈 import: ${e.reduce((e,t)=>t.imports?e+t.imports.filter(e=>e.isLocal).length:e,0)}개\n\n## 전체 셀 내용\n\n`;e.forEach((e,t)=>{a+=`### 셀 ${t+1} (ID: ${e.id})\n\`\`\`python\n${e.content}\n\`\`\`\n`,e.output&&(a+=`\n**실행 결과:**\n\`\`\`\n${e.output}\n\`\`\`\n`),e.imports&&e.imports.length>0&&(a+="\n**Imports:**\n",e.imports.forEach(e=>{a+=`- \`${e.module}\` (${e.isLocal?"로컬":"표준 라이브러리"})\n`})),a+="\n---\n\n"}),a+="\n## 검수 요청 사항\n\n다음 형식으로 응답해주세요:\n\n### 1. 전반적인 코드 품질 평가\n(노트북 전체의 코드 품질, 구조, 일관성 등을 평가)\n\n### 2. 발견된 주요 이슈\n(에러, 경고, 잠재적 문제점 등을 나열)\n\n### 3. 셀별 개선 제안\n각 셀에 대해 구체적인 개선 사항이 있다면:\n- **셀 X**: (개선 사항)\n  ```python\n  (개선된 코드)\n  ```\n\n### 4. 전반적인 개선 권장사항\n(노트북 전체를 개선하기 위한 일반적인 제안)\n\n### 5. 저장 권장 여부\n- ✅ **저장 권장**: (이유)\n- ⚠️ **수정 후 저장 권장**: (이유)\n- ❌ **저장 비권장**: (이유)\n",this.chatPanelRef.current.setInput(o),this.chatPanelRef.current.setLlmPrompt(a),setTimeout(()=>{this.chatPanelRef.current&&this.chatPanelRef.current.handleSendMessage().catch(e=>{console.error("[AgentPanel] Failed to send message automatically:",e)}).finally(()=>{console.log("[AgentPanel] Analysis complete, executing onComplete callback"),t()})},100)}}class f{constructor(e="/user/453467/pl2wadmprj/hdsp-agent"){this.baseUrl=e}getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length&&t.pop()?.split(";").shift()||""}getCsrfToken(){return this.getCookie("_xsrf")}getHeaders(){return{"Content-Type":"application/json","X-XSRFToken":this.getCsrfToken()}}async cellAction(e){const t=await fetch(`${this.baseUrl}/cell/action`,{method:"POST",headers:this.getHeaders(),credentials:"include",body:JSON.stringify(e)});if(!t.ok){const e=await t.json().catch(()=>({message:"API request failed"}));throw new Error(e.message||"API request failed")}return t.json()}async sendMessage(e){const t=await fetch(`${this.baseUrl}/chat/message`,{method:"POST",headers:this.getHeaders(),credentials:"include",body:JSON.stringify(e)});if(!t.ok){const n=await t.json().catch(()=>({message:`Failed to send message (${t.status})`,error:`HTTP ${t.status}: ${t.statusText}`}));throw console.error("Chat API error:",n),console.error("Response status:",t.status),console.error("Request:",e),new Error(n.message||n.error||`Failed to send message (${t.status})`)}return t.json()}async sendMessageStream(e,t,n){const o=await fetch(`${this.baseUrl}/chat/stream`,{method:"POST",headers:this.getHeaders(),credentials:"include",body:JSON.stringify(e)});if(!o.ok){const e=await o.text();throw new Error(`Failed to send message: ${e}`)}const a=o.body?.getReader();if(!a)throw new Error("Response body is not readable");const r=new TextDecoder;let s="";try{for(;;){const{done:e,value:o}=await a.read();if(e)break;s+=r.decode(o,{stream:!0});const l=s.split("\n");s=l.pop()||"";for(const e of l)if(e.startsWith("data: "))try{const o=JSON.parse(e.slice(6));if(o.error)throw new Error(o.error);o.conversationId&&n&&n({conversationId:o.conversationId,messageId:o.messageId,provider:o.metadata?.provider,model:o.metadata?.model}),o.content&&t(o.content),o.done&&o.metadata&&n&&n({provider:o.metadata.provider,model:o.metadata.model})}catch(t){if(!(t instanceof SyntaxError))throw t;console.warn("Failed to parse SSE data:",e)}}}finally{a.releaseLock()}}async saveConfig(e){const t=await fetch(`${this.baseUrl}/config`,{method:"POST",headers:this.getHeaders(),credentials:"include",body:JSON.stringify(e)});if(!t.ok){const e=await t.json().catch(()=>({message:"Failed to save configuration"}));throw new Error(e.message||"Failed to save configuration")}}async getConfig(){const e=await fetch(`${this.baseUrl}/config`);if(!e.ok)throw new Error("Failed to load configuration");return e.json()}async getStatus(){const e=await fetch(`${this.baseUrl}/status`);if(!e.ok)throw new Error("Failed to get status");return e.json()}async getModels(){const e=await fetch(`${this.baseUrl}/models`);if(!e.ok)throw new Error("Failed to load models");return e.json()}}const y="hdsp-agent:toggle-sidebar",b={id:"@hdsp-agent/sidebar",autoStart:!0,requires:[],optional:[o.ILayoutRestorer,a.ICommandPalette],activate:(e,t,n)=>{console.log("[SidebarPlugin] Activating Jupyter Agent Sidebar");try{const o=new f,r=new h(o);if(t){const e=new a.WidgetTracker({namespace:"hdsp-agent"});e.add(r),t.restore(e,{command:y,name:()=>"hdsp-agent"})}e.shell.add(r,"right",{rank:100}),e.commands.addCommand(y,{label:"HDSP Agent 사이드바 토글",caption:"HDSP Agent 패널 표시/숨기기",execute:()=>{r.isVisible?r.close():e.shell.activateById(r.id)}}),n&&n.addItem({command:y,category:"HDSP Agent",args:{}}),window._hdspAgentPanel=r,console.log("[SidebarPlugin] HDSP Agent Sidebar activated successfully")}catch(e){console.error("[SidebarPlugin] Failed to activate:",e)}}};var v,x,E=n(6766);!function(e){e.EXPLAIN="explain",e.FIX="fix",e.CUSTOM_PROMPT="custom_prompt"}(v||(v={})),function(e){e.CELL_ACTION="hdsp-agent:cell-action",e.CONFIG_CHANGED="hdsp-agent:config-changed",e.MESSAGE_SENT="hdsp-agent:message-sent",e.MESSAGE_RECEIVED="hdsp-agent:message-received"}(x||(x={}));const w={id:"@hdsp-agent/cell-buttons",autoStart:!0,requires:[E.INotebookTracker],activate:(e,t)=>{console.log("[CellButtonsPlugin] Activated"),window.jupyterapp=e,t.widgetAdded.connect((e,t)=>{console.log("[CellButtonsPlugin] Notebook widget added:",t.id),t.sessionContext.ready.then(()=>{k(t)}).catch(e=>{console.error("[CellButtonsPlugin] Error waiting for session:",e)})}),t.currentWidget&&k(t.currentWidget),t.currentChanged.connect((e,t)=>{t&&k(t)})}};function k(e){const t=e.content;setTimeout(()=>{C(t,e),setTimeout(()=>{C(t,e)},500)},200);const n=()=>{setTimeout(()=>{C(t,e)},100)};try{t.model?.cells.changed.disconnect(n)}catch{}t.model?.cells.changed.connect(n)}function C(e,t){for(let t=0;t<e.widgets.length;t++)S(e.widgets[t])}function S(e,t){if(!e||!e.model)return;const n=e.node;if(!n||!n.classList.contains("jp-Cell"))return;if(n.querySelector(".jp-hdsp-cell-buttons"))return;const o=n.querySelector(".jp-InputPrompt, .jp-OutputPrompt"),a=o?o.getBoundingClientRect().width:64,r=n.querySelector(".jp-Cell-inputWrapper");if(!r)return;const s=document.createElement("div");s.className="jp-hdsp-cell-buttons",s.style.cssText=`\n    display: flex;\n    gap: 4px;\n    padding: 4px 8px;\n    padding-left: ${a}px;\n    background: transparent;\n  `;const l=j("E","설명 요청",()=>{P(v.EXPLAIN,e)}),i=j("F","수정 제안 요청",()=>{P(v.FIX,e)}),c=j("?","질문하기",()=>{P(v.CUSTOM_PROMPT,e)});s.appendChild(l),s.appendChild(i),s.appendChild(c),r.parentNode?.insertBefore(s,r)}function j(e,t,n){const o=document.createElement("button");return o.className="jp-agent-button",o.textContent=e,o.title=t,o.setAttribute("aria-label",t),o.onclick=n,o.style.cssText="\n    width: 24px !important;\n    height: 24px !important;\n    border: 1px solid #ddd !important;\n    border-radius: 4px !important;\n    background: white !important;\n    cursor: pointer !important;\n    display: inline-flex !important;\n    align-items: center !important;\n    justify-content: center !important;\n    font-size: 12px !important;\n    font-weight: bold !important;\n    color: #333 !important;\n    padding: 0 !important;\n    margin: 0 2px !important;\n    opacity: 1 !important;\n    visibility: visible !important;\n  ",o}async function P(e,t){const n=t.model.sharedModel.getSource();if(!n.trim())return void M("셀 내용이 비어있습니다.","warning");const o=A(t);if(e===v.CUSTOM_PROMPT)!function(e){const t=e.model.sharedModel.getSource(),n=A(e),o=T(e);console.log("커스텀 프롬프트 다이얼로그 표시",n,o),I("jp-agent-custom-prompt-dialog");const a=L("jp-agent-custom-prompt-dialog"),r=N("500px");r.innerHTML=`\n    <div style="margin-bottom: 20px;">\n      <h3 style="margin: 0 0 8px 0; color: #424242; font-size: 16px; font-weight: 500;">\n        셀에 대해 질문하기\n      </h3>\n      <p style="margin: 0; color: #757575; font-size: 13px;">\n        물리적 위치: 셀 ${n+1}번째 (위에서 아래로 카운트)\n      </p>\n    </div>\n    <div style="margin-bottom: 20px;">\n      <textarea class="jp-agent-custom-prompt-input"\n        placeholder="이 셀에 대해 질문할 내용을 입력하세요..."\n        style="\n          width: 100%;\n          min-height: 100px;\n          padding: 12px;\n          border: 1px solid #d1d5db;\n          border-radius: 4px;\n          font-size: 14px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n          resize: vertical;\n          box-sizing: border-box;\n        "\n      ></textarea>\n    </div>\n    <div style="display: flex; gap: 12px; justify-content: flex-end;">\n      <button class="jp-agent-custom-prompt-cancel-btn" style="\n        background: transparent;\n        color: #616161;\n        border: 1px solid #d1d5db;\n        border-radius: 3px;\n        padding: 8px 16px;\n        font-size: 13px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.15s ease;\n      ">취소</button>\n      <button class="jp-agent-custom-prompt-submit-btn" style="\n        background: transparent;\n        color: #1976d2;\n        border: 1px solid #1976d2;\n        border-radius: 3px;\n        padding: 8px 16px;\n        font-size: 13px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.15s ease;\n      ">질문</button>\n    </div>\n  `,a.appendChild(r),document.body.appendChild(a);const s=r.querySelector(".jp-agent-custom-prompt-input");setTimeout(()=>s?.focus(),100);const l=r.querySelector(".jp-agent-custom-prompt-cancel-btn"),i=r.querySelector(".jp-agent-custom-prompt-submit-btn");l.addEventListener("click",()=>{a.remove()}),l.addEventListener("mouseenter",()=>{l.style.background="#f5f5f5",l.style.borderColor="#9ca3af"}),l.addEventListener("mouseleave",()=>{l.style.background="transparent",l.style.borderColor="#d1d5db"});const c=async()=>{const r=s?.value.trim()||"";if(!r)return void M("질문 내용을 입력해주세요.","warning");a.remove();const l=$(e),i=`${n}번째 셀: ${r}`;let c=`${r}\n\n셀 내용:\n\`\`\`\n${t}\n\`\`\``;l&&(c+=`\n\n실행 결과:\n\`\`\`\n${l}\n\`\`\``);const d=window._hdspAgentPanel;if(d){const e=window.jupyterapp;if(e&&e.shell.activateById(d.id),d.addCellActionMessage){const e=n-1;d.addCellActionMessage(v.CUSTOM_PROMPT,t,i,c,o,e)}}};i.addEventListener("click",c),i.addEventListener("mouseenter",()=>{i.style.background="rgba(25, 118, 210, 0.1)"}),i.addEventListener("mouseleave",()=>{i.style.background="transparent"}),s?.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),c())}),a.addEventListener("click",e=>{e.target===a&&a.remove()});const d=e=>{"Escape"===e.key&&(a.remove(),document.removeEventListener("keydown",d))};document.addEventListener("keydown",d)}(t);else{const a=$(t);let r="",s="";switch(e){case v.EXPLAIN:r=`셀 ${o}번째: 설명 요청`,s="이 셀의 코드 설명을 보시겠습니까?";break;case v.FIX:r=`셀 ${o}번째: 수정 제안 요청`,s="이 셀의 코드 개선 제안을 받으시겠습니까?"}const l=await function(e,t){return new Promise(n=>{I("jp-agent-confirm-dialog");const o=L("jp-agent-confirm-dialog"),a=N();a.innerHTML=`\n      <div style="margin-bottom: 20px;">\n        <h3 style="margin: 0 0 12px 0; color: #424242; font-size: 16px; font-weight: 500;">\n          ${_(e)}\n        </h3>\n        <p style="margin: 0; color: #616161; font-size: 14px; line-height: 1.5;">\n          ${_(t)}\n        </p>\n      </div>\n      <div style="display: flex; gap: 12px; justify-content: flex-end;">\n        <button class="jp-agent-confirm-cancel-btn" style="\n          background: transparent;\n          color: #616161;\n          border: 1px solid #d1d5db;\n          border-radius: 3px;\n          padding: 8px 16px;\n          font-size: 13px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.15s ease;\n        ">취소</button>\n        <button class="jp-agent-confirm-submit-btn" style="\n          background: #1976d2;\n          color: white;\n          border: 1px solid #1976d2;\n          border-radius: 3px;\n          padding: 8px 16px;\n          font-size: 13px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.15s ease;\n        ">확인</button>\n      </div>\n    `,o.appendChild(a),document.body.appendChild(o);const r=a.querySelector(".jp-agent-confirm-cancel-btn"),s=a.querySelector(".jp-agent-confirm-submit-btn");r.addEventListener("click",()=>{o.remove(),n(!1)}),r.addEventListener("mouseenter",()=>{r.style.background="#f5f5f5"}),r.addEventListener("mouseleave",()=>{r.style.background="transparent"}),s.addEventListener("click",()=>{s.disabled=!0,s.textContent="처리 중...",setTimeout(()=>{o.remove(),n(!0)},100)}),s.addEventListener("mouseenter",()=>{s.disabled||(s.style.background="#1565c0")}),s.addEventListener("mouseleave",()=>{s.disabled||(s.style.background="#1976d2")});const l=e=>{"Escape"===e.key&&(o.remove(),document.removeEventListener("keydown",l),n(!1))};document.addEventListener("keydown",l),o.addEventListener("click",e=>{e.target===o&&(o.remove(),document.removeEventListener("keydown",l),n(!1))})})}(r,s);l&&function(e,t,n,o,a){const r=window._hdspAgentPanel;if(!r)return void console.error("[CellButtonsPlugin] Agent panel not found. Make sure sidebar plugin is loaded.");const s=T(t),l=window.jupyterapp;l&&l.shell.activateById(r.id);let i="",c="";switch(e){case v.EXPLAIN:i=`${o}번째 셀: 설명 요청`,c=`다음 Jupyter 셀의 내용을 자세히 설명해주세요:\n\n\`\`\`python\n${n}\n\`\`\``;break;case v.FIX:a&&(a.includes("Error")||a.includes("Traceback")||a.includes("Exception")||a.includes("에러")||a.includes("오류"))&&a?(i=`${o}번째 셀: 에러 수정 요청`,c=`다음 Jupyter 셀 코드에 에러가 발생했습니다.\n\n원본 코드:\n\`\`\`python\n${n}\n\`\`\`\n\n에러:\n\`\`\`\n${a}\n\`\`\`\n\n다음 형식으로 응답해주세요:\n\n## 에러 원인\n(에러가 발생한 원인을 간단히 설명)\n\n## 수정 방법\n\n### 방법 1: (수정 방법 제목)\n(이 방법에 대한 간단한 설명)\n\`\`\`python\n(수정된 코드)\n\`\`\`\n\n### 방법 2: (수정 방법 제목)\n(이 방법에 대한 간단한 설명)\n\`\`\`python\n(수정된 코드)\n\`\`\`\n\n### 방법 3: (수정 방법 제목) (있는 경우)\n(이 방법에 대한 간단한 설명)\n\`\`\`python\n(수정된 코드)\n\`\`\`\n\n최소 2개, 최대 3개의 다양한 수정 방법을 제안해주세요.`):(i=`${o}번째 셀: 개선 제안 요청`,c=`다음 Jupyter 셀 코드를 리뷰하고 개선 방법을 제안해주세요.\n\n코드:\n\`\`\`python\n${n}\n\`\`\`\n\n다음 형식으로 응답해주세요:\n\n## 코드 분석\n(현재 코드의 기능과 특징을 간단히 설명)\n\n## 개선 방법\n\n### 방법 1: (개선 방법 제목)\n(이 방법에 대한 간단한 설명)\n\`\`\`python\n(개선된 코드)\n\`\`\`\n\n### 방법 2: (개선 방법 제목)\n(이 방법에 대한 간단한 설명)\n\`\`\`python\n(개선된 코드)\n\`\`\`\n\n### 방법 3: (개선 방법 제목) (있는 경우)\n(이 방법에 대한 간단한 설명)\n\`\`\`python\n(개선된 코드)\n\`\`\`\n\n최소 2개, 최대 3개의 다양한 개선 방법을 제안해주세요.`)}if(r.addCellActionMessage){const t=o-1;r.addCellActionMessage(e,n,i,c,s,t)}}(e,t,n,o,a)}}function A(e){const t=window.jupyterapp,n=t?.shell?.currentWidget?.content;if(!n)return-1;const o=n.widgets;for(let t=0;t<o.length;t++)if(o[t]===e)return t+1;return-1}function $(e){if("code"!==e.model.type)return"";const t=e.model.outputs;if(!t||0===t.length)return"";const n=[];for(let e=0;e<t.length;e++){const o=t.get(e),a=o.type;if("stream"===a){const e=o.text;Array.isArray(e)?n.push(e.join("")):n.push(e)}else if("execute_result"===a||"display_data"===a){const e=o.data;if(e["text/plain"]){const t=e["text/plain"];Array.isArray(t)?n.push(t.join("")):n.push(t)}}else if("error"===a){const e=o.traceback;Array.isArray(e)&&n.push(e.join("\n"))}}return n.join("\n")}function T(e){const t=e.model;let n;try{t.metadata&&"function"==typeof t.metadata.get?n=t.metadata.get("jupyterAgentCellId"):t.metadata?.jupyterAgentCellId&&(n=t.metadata.jupyterAgentCellId)}catch(e){}if(!n){n=`cell-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;try{t.metadata&&"function"==typeof t.metadata.set?t.metadata.set("jupyterAgentCellId",n):t.metadata&&(t.metadata.jupyterAgentCellId=n)}catch(e){}}return n}function I(e){const t=document.querySelector(`.${e}`);t&&t.remove()}function L(e){const t=document.createElement("div");return t.className=e,t.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background: rgba(0, 0, 0, 0.3);\n    z-index: 10000;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  ",t}function N(e="400px"){const t=document.createElement("div");return t.style.cssText=`\n    background: #fafafa;\n    border: 1px solid #e0e0e0;\n    border-radius: 4px;\n    padding: 24px;\n    max-width: ${e};\n    width: 90%;\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  `,t}function _(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function M(e,t="info"){const n=function(e,t){const n=document.createElement("div");return n.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    padding: 12px 16px;\n    border-radius: 6px;\n    color: white;\n    font-size: 14px;\n    font-weight: 500;\n    z-index: 10001;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n    max-width: 300px;\n    word-wrap: break-word;\n    background: ${t};\n  `,n.textContent=e,n}(e,function(e){switch(e){case"error":return"#f56565";case"warning":return"#ed8936";default:return"#4299e1"}}(t));document.body.appendChild(n),function(e){setTimeout(()=>e.style.opacity="1",10),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},3e3)}(n)}var z=n(8477),F=n(3070),R=n(1247),H=n(6661),B=n(561),O=n(4848);const D=(0,B.A)((0,O.jsx)("path",{d:"M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.996.996 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"}),"AutoFixHigh"),K=["타이타닉 생존자 예측을 dask와 lgbm으로 생성해줘","주식 데이터 분석 및 시각화 노트북 만들어줘","Iris 데이터셋으로 분류 모델 학습하기","시계열 데이터 분석 및 예측 모델 만들기"],q=({open:e,onClose:t,onGenerate:n})=>{const[o,a]=(0,r.useState)(""),[l,i]=(0,r.useState)(!1),[c,d]=(0,r.useState)(0),[p,u]=(0,r.useState)(""),m=()=>{o.trim()&&(i(!0),n(o.trim()),a(""),i(!1),t())};return s().createElement(H.Dialog,{open:e,onClose:t,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:2,minHeight:"400px"}}},s().createElement(H.DialogTitle,null,s().createElement(H.Box,{display:"flex",alignItems:"center",gap:1},s().createElement(D,{color:"primary"}),s().createElement(H.Typography,{variant:"h6"},"HDSP 프롬프트로 노트북 생성"))),s().createElement(H.DialogContent,null,s().createElement(H.Box,{display:"flex",flexDirection:"column",gap:2,mt:1},s().createElement(H.Typography,{variant:"body2",color:"text.secondary"},"원하는 노트북의 내용을 자연어로 설명해주세요. AI가 자동으로 노트북을 생성합니다."),s().createElement(H.TextField,{autoFocus:!0,multiline:!0,rows:6,fullWidth:!0,variant:"outlined",placeholder:"예: 타이타닉 생존자 예측을 dask와 lgbm으로 생성해줘",value:o,onChange:e=>a(e.target.value),onKeyPress:e=>{"Enter"===e.key&&e.ctrlKey&&m()},disabled:l,sx:{"& .MuiOutlinedInput-root":{fontSize:"14px"}}}),s().createElement(H.Box,null,s().createElement(H.Typography,{variant:"caption",color:"text.secondary",display:"block",mb:1},"예시 프롬프트 (클릭하여 사용):"),s().createElement(H.Box,{display:"flex",flexWrap:"wrap",gap:1},K.map((e,t)=>s().createElement(H.Chip,{key:t,label:e,variant:"outlined",size:"small",onClick:()=>(e=>{a(e)})(e),sx:{cursor:"pointer","&:hover":{backgroundColor:"action.hover"}}})))),s().createElement(H.Box,{sx:{backgroundColor:"action.hover",borderRadius:1,padding:2}},s().createElement(H.Typography,{variant:"caption",color:"text.secondary"},"💡 ",s().createElement("strong",null,"팁:"),s().createElement("br",null),"• 사용할 라이브러리를 명시하면 더 정확합니다",s().createElement("br",null),"• 분석 목적과 데이터를 구체적으로 설명하세요",s().createElement("br",null),"• Ctrl + Enter로 빠르게 생성할 수 있습니다",s().createElement("br",null),"• 생성은 백그라운드에서 진행되며, 완료되면 알림을 받습니다")))),s().createElement(H.DialogActions,{sx:{padding:2,paddingTop:0}},s().createElement(H.Button,{onClick:t,disabled:l},"취소"),s().createElement(H.Button,{onClick:m,variant:"contained",disabled:!o.trim()||l,startIcon:s().createElement(D,null)},"생성 시작")))},W=(0,B.A)((0,O.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),G=(0,B.A)((0,O.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore"),U=(0,B.A)((0,O.jsx)("path",{d:"m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"}),"ExpandLess"),J=(0,B.A)((0,O.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"}),"CheckCircle"),X=(0,B.A)((0,O.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-2h2zm0-4h-2V7h2z"}),"Error"),V=(0,B.A)((0,O.jsx)("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2m5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12z"}),"Cancel"),Z=({taskStatus:e,onClose:t,onCancel:n,onOpenNotebook:o})=>{const[a,l]=(0,r.useState)(!0),[i,c]=(0,r.useState)(!1),{status:d,progress:p,message:u,prompt:m,error:g,notebookPath:h}=e,f="completed"===d,y="failed"===d,b="running"===d,v=f||y||"cancelled"===d;return s().createElement(H.Card,{sx:{position:"fixed",bottom:20,right:20,width:a?380:320,maxWidth:"90vw",boxShadow:3,zIndex:1300,transition:"all 0.3s ease"}},s().createElement(H.CardContent,{sx:{padding:2,"&:last-child":{paddingBottom:2}}},s().createElement(H.Box,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},s().createElement(H.Box,{display:"flex",alignItems:"center",gap:1},s().createElement(H.Typography,{variant:"subtitle2",fontWeight:"bold"},"노트북 생성"),s().createElement(H.Chip,{label:(x=d,{pending:"대기 중",running:"생성 중",completed:"완료",failed:"실패",cancelled:"취소됨"}[x]||x),size:"small",color:(e=>{switch(e){case"completed":return"success";case"failed":return"error";case"cancelled":return"default";default:return"primary"}})(d),icon:(e=>{switch(e){case"completed":return s().createElement(J,{fontSize:"small"});case"failed":return s().createElement(X,{fontSize:"small"});case"cancelled":return s().createElement(V,{fontSize:"small"});default:return null}})(d)||void 0})),s().createElement(H.Box,{display:"flex"},s().createElement(H.IconButton,{size:"small",onClick:()=>c(!i)},i?s().createElement(U,{fontSize:"small"}):s().createElement(G,{fontSize:"small"})),s().createElement(H.IconButton,{size:"small",onClick:t},s().createElement(W,{fontSize:"small"})))),!v&&s().createElement(H.Box,{mb:2},s().createElement(H.LinearProgress,{variant:"determinate",value:p,sx:{height:6,borderRadius:1}}),s().createElement(H.Box,{display:"flex",justifyContent:"space-between",mt:.5},s().createElement(H.Typography,{variant:"caption",color:"text.secondary"},u),s().createElement(H.Typography,{variant:"caption",color:"text.secondary"},p,"%"))),f&&s().createElement(H.Box,{mb:2},s().createElement(H.Typography,{variant:"body2",color:"success.main"},"✓ ",u)),y&&g&&s().createElement(H.Box,{mb:2},s().createElement(H.Typography,{variant:"body2",color:"error.main"},"✗ ",g)),s().createElement(H.Collapse,{in:i},s().createElement(H.Box,{sx:{backgroundColor:"action.hover",borderRadius:1,padding:1.5,mb:2}},s().createElement(H.Typography,{variant:"caption",color:"text.secondary",display:"block",mb:.5},"프롬프트:"),s().createElement(H.Typography,{variant:"body2",sx:{wordBreak:"break-word"}},m),h&&s().createElement(s().Fragment,null,s().createElement(H.Typography,{variant:"caption",color:"text.secondary",display:"block",mt:1,mb:.5},"저장 위치:"),s().createElement(H.Typography,{variant:"caption",sx:{wordBreak:"break-all",fontFamily:"monospace"}},h)))),s().createElement(H.Box,{display:"flex",gap:1,justifyContent:"flex-end"},b&&s().createElement(H.Button,{size:"small",variant:"outlined",onClick:n},"취소"),f&&h&&s().createElement(H.Button,{size:"small",variant:"contained",onClick:o},"노트북 열기"),v&&s().createElement(H.Button,{size:"small",variant:"text",onClick:t},"닫기"))));var x};class Q{constructor(e="/hdsp-agent"){this.baseUrl=e,this.eventSources=new Map}getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length&&t.pop()?.split(";").shift()||""}getCsrfToken(){return this.getCookie("_xsrf")}getHeaders(){return{"Content-Type":"application/json","X-XSRFToken":this.getCsrfToken()}}async generateNotebook(e){const t=await fetch(`${this.baseUrl}/notebook/generate`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(e)});if(!t.ok){const e=await t.json().catch(()=>({message:"Failed to start notebook generation"}));throw new Error(e.message||"Failed to start notebook generation")}return t.json()}async getTaskStatus(e){const t=await fetch(`${this.baseUrl}/task/${e}/status`);if(!t.ok){const e=await t.json().catch(()=>({message:"Failed to get task status"}));throw new Error(e.message||"Failed to get task status")}return t.json()}subscribeToTaskProgress(e,t,n,o){this.unsubscribeFromTask(e);const a=new EventSource(`${this.baseUrl}/task/${e}/stream`);return a.onmessage=a=>{try{const n=JSON.parse(a.data);t(n),["completed","failed","cancelled"].includes(n.status)&&(this.unsubscribeFromTask(e),o&&o())}catch(e){console.error("Failed to parse SSE message:",e),n&&n(e)}},a.onerror=t=>{console.error("SSE connection error:",t),this.unsubscribeFromTask(e),n&&n(new Error("Connection to server lost"))},this.eventSources.set(e,a),()=>this.unsubscribeFromTask(e)}unsubscribeFromTask(e){const t=this.eventSources.get(e);t&&(t.close(),this.eventSources.delete(e))}async cancelTask(e){const t=await fetch(`${this.baseUrl}/task/${e}/cancel`,{method:"POST",headers:this.getHeaders()});if(!t.ok){const e=await t.json().catch(()=>({message:"Failed to cancel task"}));throw new Error(e.message||"Failed to cancel task")}this.unsubscribeFromTask(e)}dispose(){for(const[e,t]of this.eventSources)this.unsubscribeFromTask(e)}}const Y="hdsp-agent:generate-from-prompt",ee=new l.LabIcon({name:"hdsp-agent:hdsp-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><text x="1" y="13" font-size="12">🤖</text></svg>\n'});class te extends a.ReactWidget{constructor(e,t){super(),this.app=e,this.docManager=t,this.taskService=new Q,this.activeTasks=new Map,this.addClass("jp-TaskManagerWidget")}async startGeneration(e){try{const t=(await this.taskService.generateNotebook({prompt:e})).taskId;this.taskService.subscribeToTaskProgress(t,e=>{this.activeTasks.set(t,e),this.update(),"completed"===e.status&&e.notebookPath?a.Notification.success(`노트북 생성 완료: ${e.notebookPath.split("/").pop()}`,{autoClose:5e3}):"failed"===e.status&&a.Notification.error(`노트북 생성 실패: ${e.error}`,{autoClose:1e4})},e=>{console.error("Task progress error:",e),a.Notification.error("진행상황 연결 실패",{autoClose:5e3})},()=>{this.update()}),a.Notification.info("노트북 생성을 시작했습니다",{autoClose:3e3}),this.update()}catch(e){console.error("Failed to start generation:",e),a.Notification.error(`생성 시작 실패: ${e.message}`,{autoClose:5e3})}}async cancelTask(e){try{await this.taskService.cancelTask(e),this.activeTasks.delete(e),this.update(),a.Notification.info("작업을 취소했습니다",{autoClose:3e3})}catch(e){console.error("Failed to cancel task:",e),a.Notification.error(`취소 실패: ${e.message}`,{autoClose:5e3})}}closeTask(e){this.taskService.unsubscribeFromTask(e),this.activeTasks.delete(e),this.update()}async openNotebook(e,t){try{const n=e.split("/").pop()||e;await this.docManager.openOrReveal(n),this.closeTask(t),a.Notification.success(`노트북을 열었습니다: ${n}`,{autoClose:3e3})}catch(e){console.error("Failed to open notebook:",e),a.Notification.error(`노트북 열기 실패: ${e.message}`,{autoClose:5e3})}}render(){const e=(0,H.createTheme)(),t=Array.from(this.activeTasks.entries());return s().createElement(H.ThemeProvider,{theme:e},s().createElement("div",{style:{position:"fixed",bottom:0,right:0,zIndex:1300}},t.map(([e,n],o)=>s().createElement("div",{key:e,style:{marginBottom:o<t.length-1?"10px":"0"}},s().createElement(Z,{taskStatus:n,onClose:()=>this.closeTask(e),onCancel:()=>this.cancelTask(e),onOpenNotebook:()=>n.notebookPath&&this.openNotebook(n.notebookPath,e)})))))}dispose(){this.taskService.dispose(),super.dispose()}}class ne extends a.ReactWidget{constructor(e,t){super(),this._onGenerate=e,this._onClose=t}render(){const e=(0,H.createTheme)();return s().createElement(H.ThemeProvider,{theme:e},s().createElement(q,{open:!0,onClose:this._onClose,onGenerate:this._onGenerate}))}}async function oe(e,t,n,o,a,r){const s=await new Promise(e=>{const t=document.querySelector(".jp-agent-save-confirm-modal");t&&t.remove();const n=document.createElement("div");n.className="jp-agent-save-confirm-modal",n.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.3);\n      z-index: 10000;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    ";const o=document.createElement("div");o.style.cssText="\n      background: var(--jp-layout-color1);\n      border: 1px solid var(--jp-border-color1);\n      border-radius: 4px;\n      padding: 24px;\n      max-width: 400px;\n      width: 90%;\n      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n      font-family: var(--jp-ui-font-family);\n    ",o.innerHTML='\n      <div style="margin-bottom: 20px;">\n        <h3 style="margin: 0 0 12px 0; color: var(--jp-ui-font-color1); font-size: 16px; font-weight: 500;">\n          저장 전에 코드 검수를 하겠습니까?\n        </h3>\n        <p style="margin: 0; color: var(--jp-ui-font-color2); font-size: 14px; line-height: 1.5;">\n          노트북을 저장하기 전에 모든 셀의 코드와 출력을 분석하여 최적화 제안을 받으시겠습니까?\n        </p>\n      </div>\n      <div style="display: flex; gap: 12px; justify-content: flex-end;">\n        <button class="jp-agent-save-direct-btn" style="\n          background: transparent;\n          color: var(--jp-ui-font-color2);\n          border: 1px solid var(--jp-border-color2);\n          border-radius: 3px;\n          padding: 8px 16px;\n          font-size: 13px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.15s ease;\n        ">그냥 저장하기</button>\n        <button class="jp-agent-save-analysis-btn" style="\n          background: var(--jp-brand-color1);\n          color: white;\n          border: 1px solid var(--jp-brand-color1);\n          border-radius: 3px;\n          padding: 8px 16px;\n          font-size: 13px;\n          font-weight: 500;\n          cursor: pointer;\n          transition: all 0.15s ease;\n        ">검수 후 저장하기</button>\n      </div>\n    ',n.appendChild(o),document.body.appendChild(n);const a=o.querySelector(".jp-agent-save-direct-btn"),r=o.querySelector(".jp-agent-save-analysis-btn");a.addEventListener("click",()=>{console.log("[SaveInterceptorPlugin] User chose direct save"),n.remove(),e(!1)}),a.addEventListener("mouseenter",()=>{a.style.background="var(--jp-layout-color2)"}),a.addEventListener("mouseleave",()=>{a.style.background="transparent"}),r.addEventListener("click",()=>{console.log("[SaveInterceptorPlugin] User chose analysis save"),n.remove(),e(!0)}),r.addEventListener("mouseenter",()=>{r.style.opacity="0.9"}),r.addEventListener("mouseleave",()=>{r.style.opacity="1"}),n.addEventListener("click",t=>{t.target===n&&(console.log("[SaveInterceptorPlugin] User cancelled save"),n.remove(),e(null))});const s=t=>{"Escape"===t.key&&(console.log("[SaveInterceptorPlugin] User cancelled save with ESC"),n.remove(),document.removeEventListener("keydown",s),e(null))};document.addEventListener("keydown",s)});null!==s?s?await async function(e,t,n,o,a,r){console.log("[SaveInterceptorPlugin] Performing analysis save");try{const s=await async function(e){const t=e.content,n=[];for(let e=0;e<t.widgets.length;e++){const o=t.widgets[e];if("code"!==o.model.type)continue;const a=o.model.sharedModel.getSource();if(!a.trim())continue;const r=re(o),s=se(o),l=le(a),i=l.filter(e=>e.isLocal),c={};for(const e of i)e.module.startsWith(".")||(c[e.module]=`# Source for ${e.module} would be fetched from kernel`);n.push({index:e,id:r,content:a,type:"code",output:s,imports:l,localModuleSources:Object.keys(c).length>0?c:void 0})}return console.log(`[SaveInterceptorPlugin] Collected ${n.length} code cells`),n}(e);if(0===s.length)return ce("분석할 코드 셀이 없습니다. 그냥 저장합니다.","warning"),void await ae(e,0,n,o,a,r);ce("코드 분석을 시작합니다...","info");const l=window._hdspAgentPanel;if(!l)return console.error("[SaveInterceptorPlugin] Agent panel not found"),ce("Agent panel을 찾을 수 없습니다. 그냥 저장합니다.","warning"),void await ae(e,0,n,o,a,r);t&&t.shell.activateById(l.id),l.analyzeNotebook?l.analyzeNotebook(s,async()=>{await ae(e,0,n,o,a,r)}):(console.error("[SaveInterceptorPlugin] analyzeNotebook method not found on AgentPanel"),ce("분석 기능을 사용할 수 없습니다. 그냥 저장합니다.","warning"),await ae(e,0,n,o,a,r))}catch(t){console.error("[SaveInterceptorPlugin] Analysis save failed:",t),ce("분석에 실패했습니다. 그냥 저장합니다.","warning"),await ae(e,0,n,o,a,r)}}(e,t,n,o,a,r):await ae(e,0,n,o,a,r):r()}async function ae(e,t,n,o,a,r){console.log("[SaveInterceptorPlugin] Performing direct save"),a();try{if(n)await n(o),ce("저장이 완료되었습니다.","success");else{const t=e.context;t&&(await t.save(),ce("저장이 완료되었습니다.","success"))}}catch(e){console.error("[SaveInterceptorPlugin] Save failed:",e),ce("저장에 실패했습니다.","error")}finally{r()}}function re(e){const t=e.model;let n;try{t.metadata&&"function"==typeof t.metadata.get?n=t.metadata.get("jupyterAgentCellId"):t.metadata?.jupyterAgentCellId&&(n=t.metadata.jupyterAgentCellId)}catch(e){}if(!n){n=`cell-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;try{t.metadata&&"function"==typeof t.metadata.set?t.metadata.set("jupyterAgentCellId",n):t.metadata&&(t.metadata.jupyterAgentCellId=n)}catch(e){}}return n}function se(e){if("code"!==e.model.type)return"";const t=e.model.outputs;if(!t||0===t.length)return"";const n=[];for(let e=0;e<t.length;e++){const o=t.get(e),a=o.type;if("stream"===a){const e=o.text;Array.isArray(e)?n.push(e.join("")):n.push(e)}else if("execute_result"===a||"display_data"===a){const e=o.data;if(e["text/plain"]){const t=e["text/plain"];Array.isArray(t)?n.push(t.join("")):n.push(t)}}else if("error"===a){const e=o.traceback;Array.isArray(e)&&n.push(e.join("\n"))}}return n.join("\n")}function le(e){const t=[],n=e.split("\n");for(const e of n){const n=e.trim();if(n.startsWith("#")||""===n)continue;const o=n.match(/^from\s+(\.+[\w.]*)\s+import\s+([\w,\s*]+)/);if(o){t.push({module:o[1],items:o[2],isLocal:!0});continue}const a=n.match(/^from\s+([\w.]+)\s+import\s+([\w,\s*]+)/);if(a){const e=a[1];t.push({module:e,items:a[2],isLocal:ie(e)});continue}const r=n.match(/^import\s+([\w,\s.]+)/);r&&r[1].split(",").map(e=>e.trim().split(" as ")[0]).forEach(e=>{t.push({module:e,items:e,isLocal:ie(e)})})}return t}function ie(e){if(e.startsWith("."))return!0;const t=e.split(".")[0];return!["numpy","np","pandas","pd","matplotlib","sklearn","scipy","torch","tensorflow","tf","keras","PIL","cv2","requests","json","os","sys","datetime","time","math","random","collections","itertools","functools","re","pathlib","typing","dataclasses","abc","argparse","logging","pickle","csv","sqlite3","http","urllib","email","plotly","seaborn","statsmodels","xgboost","lightgbm","transformers","datasets","accelerate","peft","openai","anthropic","langchain","llama_index"].includes(t)}function ce(e,t="info"){const n=function(e,t){const n=document.createElement("div");return n.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    padding: 12px 20px;\n    border-radius: 8px;\n    color: white;\n    font-size: 14px;\n    font-weight: 500;\n    z-index: 10001;\n    opacity: 0;\n    transition: opacity 0.3s ease;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n    max-width: 300px;\n    word-wrap: break-word;\n    background: ${t};\n  `,n.textContent=e,n}(e,function(e){const t={success:"#48bb78",error:"#f56565",warning:"#ed8936",info:"#4299e1"};return t[e]||t.info}(t));document.body.appendChild(n),function(e){setTimeout(()=>{e.style.opacity="1"},10),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},3e3)}(n)}const de=[b,w,{id:"@hdsp-agent/prompt-generation",autoStart:!0,requires:[F.IDocumentManager],optional:[z.ILauncher,a.ICommandPalette],activate:(e,t,n,o)=>{console.log("[PromptGenerationPlugin] Activating");try{const a=new te(e,t);a.id="hdsp-agent-task-manager",a.title.label="Task Manager",R.Widget.attach(a,document.body),e.commands.addCommand(Y,{label:"프롬프트로 노트북 만들기",caption:"프롬프트로 노트북 만들기",icon:ee,execute:()=>{let t=null;t=new ne(async e=>{t&&(t.dispose(),t=null),await a.startGeneration(e)},()=>{t&&(t.dispose(),t=null)}),t.id="hdsp-agent-prompt-dialog",t.title.label="",e.shell.add(t,"main")}}),n&&n.add({command:Y,category:"Notebook",rank:1}),o&&o.addItem({command:Y,category:"HDSP Agent"}),console.log("[PromptGenerationPlugin] Activated successfully")}catch(e){console.error("[PromptGenerationPlugin] Failed to activate:",e)}}},{id:"@hdsp-agent/save-interceptor",autoStart:!0,requires:[E.INotebookTracker],optional:[a.ICommandPalette],activate:(e,t,n)=>{console.log("[SaveInterceptorPlugin] Activated");let o=!1,a=null;if(e.commands.hasCommand("docmanager:save")){console.log("[SaveInterceptorPlugin] Found docmanager:save command");const n="docmanager:save",r=e.commands._commands.get(n);r?(a=r.execute.bind(r),console.log("[SaveInterceptorPlugin] Stored original save command"),r.execute=async n=>{const r=t.currentWidget;return console.log("[SaveInterceptorPlugin] Save command triggered",{hasCurrentWidget:!!r,isSaving:o,widgetType:r?.constructor?.name}),r?o?(console.log("[SaveInterceptorPlugin] Already in save process, executing actual save"),a(n)):(console.log("[SaveInterceptorPlugin] Intercepting save, showing modal"),void await oe(r,e,a,n,()=>o=!0,()=>o=!1)):(console.log("[SaveInterceptorPlugin] No current widget, allowing default save"),a(n))},console.log("[SaveInterceptorPlugin] Wrapped save command installed")):console.error("[SaveInterceptorPlugin] Could not find original save command")}document.addEventListener("keydown",async n=>{if((n.ctrlKey||n.metaKey)&&"s"===n.key){const r=t.currentWidget;if(!r)return;if(console.log("[SaveInterceptorPlugin] Save shortcut (Ctrl/Cmd+S) detected"),n.preventDefault(),n.stopPropagation(),o)return void console.log("[SaveInterceptorPlugin] Already saving, ignoring duplicate request");if(!a)return void console.error("[SaveInterceptorPlugin] No original save command stored");await oe(r,e,a,void 0,()=>o=!0,()=>o=!1)}},!0),console.log("[SaveInterceptorPlugin] Save interception enabled")}}]}}]);